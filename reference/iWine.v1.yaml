openapi: 3.0.0
info:
  title: iWine
  version: '1.0'
  contact:
    name: Dmitry
    email: dima@melodrom.ru
  description: "iWine HTTP API. Get current wine volume (in litres), alcohol contents (% by volume), sugar (% by mass), temperature, wine type (as a JSON list of strings and certainty values: `{\"red\":90, \"white\":1,  \"rose\":9, \"orange\":0}`). Aerate contents or cool/warm to a desired temperature. Set callback url to receive notifications to your device within LAN.\n\n## Security\n\nSince iWine must work on a LAN with no guarantee of access to Internet and CA infrastructure, it relies on a custom variant of HOBA security scheme for mutual authorisation and authentication of controllers and iWine devices.\n\nTo authorize a controller with iWine device press **PAIR** button on iWine control panel, \"PAIRING MODE\" should appear on its LED display. When in pairing mode, iWine will accept valid authorization request from a controller and display its network name (if available) or IP address on the LED display with a scrolling message: \"LONG PRESS **PAIR** TO CONFIRM, SHORT PRESS TO CANCEL\". User can confirm or cancel authorization accordingly.\n\nTo initiate a pairing request controller must  generate a secp256k1 128-bit keypair and send a POST HTTP request to iWine `/pair` endpoint with its public key in its body. If this request was accepted by iWine and confirmed by its user in a timely manner, iWine will generate a keypair and return the public key in the POST responce body with HTTP code 201. It will accept only the first valid pairing request and ignore all subsequent requests to the `/pair` endpoint until this pairing session ends and another one starts. If there were no valid pairing requests, the pairing mode will time out in 1 minute. User can abort pairing mode session by short-pressing **PAIR** again any time.\n\nThe proposed security scheme provides no protection from MITM and replay attacks, as we consider their mitigation outside of the scope of this task.\n\n## Requesting iWine status information\n\nTo request iWine status information controller must send a GET request to the `/status` endpoint. To authenticate itself it passes its public key and its public key, signed by a private key as `key` and `sig` strings, base64-encoded, as parameters of the GET request.\niWine will lookup the provided public key in its internal database of known controllers (that is stored in NVRAM) and, if found, checks the signature:\n\n  `if (secp256k1.ecdsaVerify(signature: Uint8Array.from(sig), message: Uint8Array.from(key), publicKey: Uint8Array.from(key))) {\n  // OK\n  }\n  else {\n  // ERROR\n  }`\n  \nIf verification succeeds, iWine constructs a request payload, JSON object of the following format:\n{\n  \"temp\":\"_contents_temperature_Celsius_\",\n  \"alc\":\"_alcohol_contents_by_volume_cl_per_l_\",\n  \"vol\":\"_volume_of_contents_l_\"\n  \"type\": {\n    \"red\":\n    \"white\":\n    \"rose\":\n    \"orange\":\n  }\n}\n\nIf verification failed, the `/status` endpoint will respond with `401 Unauthorized` error or `400 Bad Request` if GET request was malformed.\n\n## Sending Commands to an iWine Device\n\nTo aerate the contents of iWine device or cool/warm  the contents to a specified temperature an authorized controller must send a POST request to `/command` endpoint. To authenticate the request the requesting controller must include its public key as a base64-encoded string `key` and its public key signed with its private key as a base64-encoded string `sig` along with a _**command payload**_ in the body of the request.\n\nA _**command payload**_ is a JSON object consisting of one or both of the following items:\n`\"settemp\":\"_temperature_Celsius_\"`,\n`\"aerate\"`\nand\n`\"callback\":\"_callback_URL_\"`\nto cool/warm and/or start aeration of the contents.\nThe cooling/warming process takes about 10 to 15 minutes and completes automatically.\nWhen each of the requested processes completes, iWine will make a POST HTTP request to _callback_URL_, if provided in the payload. The body of the callback POST request will then contain a _callback_payload_:\n`aerate: ok` or`aerate: failed`,\n`settemp: _temperature_Celsius_` or `settemp: failed`, depending on the success of the requested operations.\nTo maintain the security of communication both _command_payload_ and _callback_payload_ must be encrypted with the private key of the request recipient.\n\nAn example of _command_payload_:\n```\n{\n  \"settemp\":\"15\",\n  \"aerate\",\n  \"callback\":\"192.168.0.105/iwine\"\n}\n```\nThis payload will instruct the iWine to cool or warm the contents to 15 degrees Celsius, aerate wine and call the provided endpoint after the completeion of each operation providing the information about its success or failure.\n  "
  license:
    name: GPL
servers:
  - url: localhost
    description: ''
paths:
  /status:
    get:
      summary: Your GET endpoint
      tags: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: string
                description: Status responce encrypted payload in base64
                minLength: 180
                maxLength: 188
                pattern: '^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$'
              examples: {}
        '401':
          description: Unauthorized
      operationId: get-status
      description: Returns JSON with device status information
      requestBody:
        content:
          application/json:
            schema:
              $ref: ''
      parameters:
        - schema:
            type: string
            maxLength: 22
            minLength: 22
            pattern: '^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$'
          in: query
          name: key
          description: Controller public key base64
          required: true
        - schema:
            type: string
          in: query
          name: sig
          description: Controller public key signed with private key
          required: true
  /command:
    post:
      summary: ''
      operationId: post-command
      responses:
        '200':
          description: OK
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
          headers: {}
        '422':
          description: Unprocessable Entity
      requestBody:
        content:
          application/json:
            schema:
              type: object
              description: Operations request encrypted payload + signature
              properties:
                payload:
                  type: string
                  maxLength: 1024
                  pattern: '^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$'
                  description: Operations request encrypted payload
                sig:
                  type: string
                  minLength: 44
                  maxLength: 44
                  pattern: '^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$'
                  description: Operations request encrypted payload signed with Controller private key
        description: ''
  /pair:
    post:
      summary: ''
      operationId: post-pair
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: string
                description: iWine device name and ed25519 public key
                minLength: 22
                maxLength: 22
                pattern: '^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$'
          headers: {}
        '400':
          description: |-
            Bad Request
            Switch iWine to pairing mode first
      requestBody:
        content:
          application/json:
            schema:
              type: string
              description: Requesting device name and ed25519 public key
              minLength: 22
              maxLength: 22
              pattern: '^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$'
    parameters: []
components:
  schemas: {}
  securitySchemes:
    Public key exchange:
      type: http
      scheme: hoba
      description: "When in pairing mode iWine will accept Controller \nPOST request to `/pair` endpoint with Controller public key and return 200 OK with iWine public key in responce body"
